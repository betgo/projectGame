# T-010: Batch Simulation and Balance Report

- Status: Done
- Owner: maintainer
- Branch: `main`
- Prompt-Plan: `ARCHITECT_v1`, `PLANNER_v1`
- Prompt-Impl: `BUILDER_v2`
- Prompt-Review: `GUARDIAN_v1`, `REVIEWER_v1`

## Goal

Provide a deterministic, auditable batch simulation workflow that outputs actionable balance metrics for tower-defense packages.

## Scope

- In scope:
  - Define the contract for batch simulation inputs and output metrics in `runtime/core` and `tools/simulate`.
  - Standardize balance-report fields for CLI output (`winRate`, `avgDuration`, `leakRate`, `imbalanceIndex`, sample size).
  - Add deterministic and regression test coverage for batch aggregation and report formatting.
  - Document usage and validation expectations for `pnpm simulate:batch`.
- Out of scope:
  - Any editor UI changes under `editor/`.
  - Any AI provider or prompt pipeline behavior changes under `ai/`.
  - Template gameplay rebalance beyond metric computation/reporting.
  - Remote CI/CD or cloud reporting integration.

## Acceptance Criteria

1. Running `pnpm simulate:batch <package> <rounds>` produces deterministic aggregate metrics for the same package and seed sequence.
2. Batch-report output includes stable, parseable fields for seed count, `winRate`, `avgDuration`, `leakRate`, and `imbalanceIndex`.
3. Invalid batch inputs (missing package, non-positive rounds, malformed package) fail fast with clear error messaging.
4. Automated tests cover batch metric aggregation, output formatting, and determinism guarantees.
5. Changes remain within architecture boundaries (`runtime` + `tools/simulate`) with no cross-layer leakage.

## Subtasks

- [x] [S1] Define scope and acceptance criteria
- [x] [S2] Implement scoped code changes
- [x] [S3] Pass fast and full gates
- [x] [S4] Update docs and risk notes
- [x] [S5] Milestone commit and memory finalize

## Notes

- Keep each subtask independently mergeable.
- Keep `1 Issue = 1 PR`.
- Keep commit evidence and rollback notes in task doc.

## S2 Implementation Notes (2026-02-14)

- Added runtime batch contracts for input seed generation and output metrics (`sampleSize`, `winRate`, `avgDuration`, `leakRate`, `imbalanceIndex`).
- Added strict batch CLI validation for required args, positive rounds, readable JSON, and package contract validity.
- Standardized `simulate:batch` output to stable parseable key-value fields without unit suffixes.
- Added deterministic, aggregation, formatter, and CLI failure-path test coverage.

## S3 Gate Evidence (2026-02-14)

- Executed `pnpm gate:fast` (includes `typecheck`, `test:determinism`, `test:schema`) and all commands passed.
- Executed `pnpm gate:full` (includes `lint`, `test`, `test:determinism`, `test:schema`, `test:smoke-ai-package`) and all commands passed.
- Confirmed scope remained within existing architecture boundaries and no additional contract-level changes were introduced during S3.

## S4 Docs and Risk Notes (2026-02-14)

- Updated `README.md` batch simulation contract notes to document deterministic seed generation, fail-fast input validation behavior, and imbalance-index formula.
- Added `tests/integration/batch-doc-contract.test.ts` to guard command shape and output-field order against formatter drift.
- Kept architecture boundaries unchanged (`runtime` + `tools/simulate` only for contract behavior, docs/tests for governance evidence).

## Test Evidence (S4)

- `pnpm typecheck`
- `pnpm lint`
- `pnpm test -- tests/integration/batch-doc-contract.test.ts`
- `pnpm test -- tests/integration/batch-report-format.test.ts tests/integration/simulate-batch-cli.test.ts`
- `pnpm docs:sync-check`

## Risks and Rollback (S4)

- Risk: docs can drift from formatter field order during future refactors, leading to parser breakage downstream.
- Mitigation: keep the doc-contract integration test green in CI/local gates when changing `tools/simulate/report.ts` or `README.md`.
- Rollback plan: revert `README.md`, `docs/ai/tasks/T-010.md`, and `tests/integration/batch-doc-contract.test.ts` together.

## S5 Milestone Commit and Memory Finalize (2026-02-14)

- Enhanced `tools/git-memory/append-commit-log.sh` to support multi-ref/range backfill, normalize commit-body fields, and keep file lists parseable with stable `, ` delimiters.
- Updated `tools/git-memory/render-weekly-summary.py` risk parsing to normalize legacy bullet-prefixed risk lines from commit-log entries.
- Backfilled missing memory-finalize commits (`6d0bed8`, `da3a3d8`, `ec6ed6c`) into `docs/ai/commit-log/2026-02.md` and regenerated `docs/ai/weekly-summary.md`.
- Added `tests/integration/git-memory-append-commit-log.test.ts` and `tests/integration/git-memory-weekly-summary.test.ts` to guard range behavior, duplicate-skip behavior, formatter output, and risk normalization.

## Test Evidence (S5)

- `pnpm gate:fast`
- `pnpm gate:full`
- `pnpm test -- tests/integration/git-memory-append-commit-log.test.ts`
- `pnpm test -- tests/integration/git-memory-weekly-summary.test.ts`
- `pnpm typecheck`
- `pnpm lint`
- `pnpm docs:sync-check`

## Risks and Rollback (S5)

- Risk: backfilled memory commits increase weekly-summary noise if low-risk entries accumulate.
- Mitigation: keep memory commit bodies concise and use commit-log review in each finalize loop.
- Rollback plan: revert `tools/git-memory/append-commit-log.sh`, `tools/git-memory/render-weekly-summary.py`, `tests/integration/git-memory-append-commit-log.test.ts`, `tests/integration/git-memory-weekly-summary.test.ts`, `docs/ai/commit-log/2026-02.md`, `docs/ai/weekly-summary.md`, and `docs/ai/tasks/T-010.md` together.


## Subtask Progress
- [x] [S5] Milestone commit and memory finalize