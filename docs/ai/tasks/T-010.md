# T-010: Batch Simulation and Balance Report

- Status: In Progress
- Owner: maintainer
- Branch: `codex/010-batch-sim-and-balance-report`
- Prompt-Plan: `ARCHITECT_v1`, `PLANNER_v1`
- Prompt-Impl: `BUILDER_v2`
- Prompt-Review: `GUARDIAN_v1`, `REVIEWER_v1`

## Goal

Provide a deterministic, auditable batch simulation workflow that outputs actionable balance metrics for tower-defense packages.

## Scope

- In scope:
  - Define the contract for batch simulation inputs and output metrics in `runtime/core` and `tools/simulate`.
  - Standardize balance-report fields for CLI output (`winRate`, `avgDuration`, `leakRate`, `imbalanceIndex`, sample size).
  - Add deterministic and regression test coverage for batch aggregation and report formatting.
  - Document usage and validation expectations for `pnpm simulate:batch`.
- Out of scope:
  - Any editor UI changes under `editor/`.
  - Any AI provider or prompt pipeline behavior changes under `ai/`.
  - Template gameplay rebalance beyond metric computation/reporting.
  - Remote CI/CD or cloud reporting integration.

## Acceptance Criteria

1. Running `pnpm simulate:batch <package> <rounds>` produces deterministic aggregate metrics for the same package and seed sequence.
2. Batch-report output includes stable, parseable fields for seed count, `winRate`, `avgDuration`, `leakRate`, and `imbalanceIndex`.
3. Invalid batch inputs (missing package, non-positive rounds, malformed package) fail fast with clear error messaging.
4. Automated tests cover batch metric aggregation, output formatting, and determinism guarantees.
5. Changes remain within architecture boundaries (`runtime` + `tools/simulate`) with no cross-layer leakage.

## Subtasks

- [x] [S1] Define scope and acceptance criteria
- [x] [S2] Implement scoped code changes
- [ ] [S3] Pass fast and full gates
- [ ] [S4] Update docs and risk notes
- [ ] [S5] Milestone commit and memory finalize

## Notes

- Keep each subtask independently mergeable.
- Keep `1 Issue = 1 PR`.
- Keep commit evidence and rollback notes in task doc.

## S2 Implementation Notes (2026-02-14)

- Added runtime batch contracts for input seed generation and output metrics (`sampleSize`, `winRate`, `avgDuration`, `leakRate`, `imbalanceIndex`).
- Added strict batch CLI validation for required args, positive rounds, readable JSON, and package contract validity.
- Standardized `simulate:batch` output to stable parseable key-value fields without unit suffixes.
- Added deterministic, aggregation, formatter, and CLI failure-path test coverage.


## Subtask Progress
- [x] [S2] Implement scoped code changes